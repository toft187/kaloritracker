<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1a1a2e">
<meta name="mobile-web-app-capable" content="yes">
<title>Kaloritracker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  :root {
    --bg:#0f0f1a; --card:#1a1a2e; --card2:#16213e;
    --accent:#e94560; --green:#0f9b58; --blue:#4cc9f0;
    --yellow:#f8961e; --text:#eaeaea; --muted:#888; --border:#2a2a3e;
  }
  body { background:var(--bg); color:var(--text); font-family:'Segoe UI',sans-serif; min-height:100vh; }
  nav { display:flex; background:var(--card); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; }
  nav button { flex:1; padding:14px 4px; background:none; border:none; color:var(--muted); font-size:11px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px; transition:.2s; }
  nav button.active { color:var(--accent); border-bottom:2px solid var(--accent); }
  nav button svg { width:20px; height:20px; }
  .page { display:none; padding:16px; max-width:480px; margin:0 auto; }
  .page.active { display:block; }
  .card { background:var(--card); border-radius:16px; padding:16px; margin-bottom:16px; border:1px solid var(--border); }
  h2 { font-size:13px; color:var(--muted); margin-bottom:12px; text-transform:uppercase; letter-spacing:1px; }
  .rings { display:flex; flex-direction:column; gap:12px; margin-bottom:16px; }
  .rings-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
  .ring-card { background:var(--card); border-radius:16px; padding:12px; border:1px solid var(--border); display:flex; flex-direction:column; align-items:center; }
  .ring-label { font-size:10px; color:var(--muted); margin-top:6px; text-transform:uppercase; letter-spacing:1px; }
  .ring-value { font-size:13px; font-weight:700; margin-top:2px; text-align:center; }
  canvas.donut { width:70px!important; height:70px!important; }
  .ptb-wrap { display:flex; flex-direction:column; align-items:center; padding:24px 0; }
  #ptb { width:110px; height:110px; border-radius:50%; border:none; background:linear-gradient(135deg,var(--accent),#c62a47); color:#fff; font-size:13px; font-weight:600; cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; box-shadow:0 0 0 0 rgba(233,69,96,.4); transition:.2s; }
  #ptb.listening { animation:pulse 1.2s infinite; background:linear-gradient(135deg,#e94560,#ff6b6b); }
  #ptb svg { width:32px; height:32px; }
  @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(233,69,96,.4)} 70%{box-shadow:0 0 0 20px rgba(233,69,96,0)} 100%{box-shadow:0 0 0 0 rgba(233,69,96,0)} }
  #transcript { margin-top:16px; min-height:40px; text-align:center; color:var(--muted); font-style:italic; font-size:14px; }
  #result-box { background:var(--card2); border-radius:12px; padding:14px; margin-top:12px; width:100%; display:none; border:1px solid var(--border); }
  #result-box .entry { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid var(--border); }
  #result-box .entry:last-child { border:none; }
  .entry-kcal { color:var(--accent); font-weight:700; }
  #status { text-align:center; font-size:13px; color:var(--green); margin-top:8px; min-height:20px; }
  .log-item { display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid var(--border); }
  .log-item:last-child { border:none; }
  .log-name { font-size:14px; font-weight:600; }
  .log-detail { font-size:12px; color:var(--muted); margin-top:2px; }
  .log-time { font-size:11px; color:var(--muted); }
  .log-kcal { font-size:16px; font-weight:700; color:var(--accent); }
  .empty { text-align:center; color:var(--muted); padding:32px; font-size:14px; }
  #weekChart { max-height:200px; }
  .setting-row { display:flex; justify-content:space-between; align-items:center; padding:14px 0; border-bottom:1px solid var(--border); }
  .setting-row:last-child { border:none; }
  .setting-label { font-size:14px; }
  .setting-sub { font-size:12px; color:var(--muted); }
  input[type=number] { background:var(--bg); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:8px 12px; width:90px; font-size:16px; text-align:center; }
  input[type=text] { width:100%; background:var(--bg); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:10px; font-size:13px; margin-bottom:12px; }
  .save-btn { width:100%; padding:14px; background:var(--accent); border:none; border-radius:12px; color:#fff; font-size:16px; font-weight:700; cursor:pointer; margin-top:8px; }
  .clear-btn { width:100%; padding:10px; background:none; border:1px solid var(--accent); border-radius:12px; color:var(--accent); font-size:14px; cursor:pointer; margin-top:8px; }
  #sync-status { font-size:12px; color:var(--muted); text-align:center; margin-top:8px; }
</style>
</head>
<body>

<nav>
  <button class="active" onclick="showPage('home',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
    Idag
  </button>
  <button onclick="showPage('log',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
    Logg
  </button>
  <button onclick="showPage('week',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
    Vecka
  </button>
  <button onclick="showPage('settings',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
    MÃ¥l
  </button>
</nav>

<!-- HOME -->
<div id="page-home" class="page active">
  <div class="rings">
    <div class="ring-card">
      <canvas id="calChart" class="donut"></canvas>
      <div class="ring-label">Kalorier</div>
      <div class="ring-value" id="cal-val">0 / 2000 kcal</div>
    </div>
    <div class="rings-row">
      <div class="ring-card">
        <canvas id="protChart" class="donut"></canvas>
        <div class="ring-label">Protein</div>
        <div class="ring-value" id="prot-val" style="color:#4cc9f0">0g</div>
      </div>
      <div class="ring-card">
        <canvas id="karbChart" class="donut"></canvas>
        <div class="ring-label">Kolhydrater</div>
        <div class="ring-value" id="karb-val" style="color:#f8961e">0g</div>
      </div>
      <div class="ring-card">
        <canvas id="fatChart" class="donut"></canvas>
        <div class="ring-label">Fett</div>
        <div class="ring-value" id="fat-val" style="color:#a8dadc">0g</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="ptb-wrap">
      <button id="ptb" onclick="toggleListen()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4M8 23h8"/></svg>
        HÃ¥ll & tala
      </button>
      <div id="transcript">Tryck och berÃ¤tta vad du Ã¤tit...</div>
      <div id="result-box"></div>
      <div id="status"></div>
    </div>
  </div>

  <div class="card" style="text-align:center">
    <button class="clear-btn" onclick="clearToday()">ðŸ—‘ Rensa dagens data</button>
  </div>
</div>

<!-- LOG -->
<div id="page-log" class="page">
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <button onclick="changeLogDay(-1)" style="background:none;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 12px;font-size:18px;cursor:pointer">â€¹</button>
      <div style="text-align:center">
        <div id="log-date-label" style="font-size:14px;font-weight:600"></div>
        <div id="log-date-sub" style="font-size:11px;color:var(--muted)"></div>
      </div>
      <button onclick="changeLogDay(1)" id="log-next-btn" style="background:none;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 12px;font-size:18px;cursor:pointer">â€º</button>
    </div>
    <div id="log-day-totals" style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap"></div>
    <div id="log-list"><div class="empty">Inget loggat denna dag</div></div>
  </div>
</div>

<!-- WEEK -->
<div id="page-week" class="page">
  <div class="card">
    <h2>VeckoÃ¶versikt â€“ Kalorier</h2>
    <canvas id="weekChart"></canvas>
  </div>
  <div class="card">
    <h2>Snitt denna vecka</h2>
    <div id="week-stats" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px"></div>
  </div>
</div>

<!-- SETTINGS -->
<div id="page-settings" class="page">
  <div class="card">
    <h2>API-konfiguration</h2>
    <div class="setting-label" style="margin-bottom:6px">Apps Script URL</div>
    <input type="text" id="s-url" placeholder="https://script.google.com/...">
  </div>
  <div class="card">
    <h2>Dagliga mÃ¥l</h2>
    <div class="setting-row">
      <div><div class="setting-label">Kalorier</div><div class="setting-sub">kcal per dag</div></div>
      <input type="number" id="s-kcal" value="2000">
    </div>
    <div class="setting-row">
      <div><div class="setting-label">Protein</div><div class="setting-sub">gram per dag</div></div>
      <input type="number" id="s-prot" value="150">
    </div>
    <div class="setting-row">
      <div><div class="setting-label">Kolhydrater</div><div class="setting-sub">gram per dag</div></div>
      <input type="number" id="s-karb" value="200">
    </div>
    <div class="setting-row">
      <div><div class="setting-label">Fett</div><div class="setting-sub">gram per dag</div></div>
      <input type="number" id="s-fat" value="65">
    </div>
    <button class="save-btn" onclick="saveSettings()">Spara instÃ¤llningar</button>
  </div>
</div>

<script>
// â”€â”€ STORAGE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ã„rlig kommentar: localStorage Ã¤r primÃ¤r lagring.
// Google Sheets Ã¤r sekundÃ¤r (backup + analys).
// Appen fungerar alltid oavsett om Sheets-synken lyckas.

const LS_CFG     = 'kaloricfg';
const LS_ENTRIES = 'kalorientries';

function todayKey() {
  return new Date().toISOString().slice(0,10); // yyyy-mm-dd
}

function loadEntries() {
  try {
    const all = JSON.parse(localStorage.getItem(LS_ENTRIES) || '{}');
    return all[todayKey()] || [];
  } catch(e) { return []; }
}

function saveEntries(entries) {
  try {
    const all = JSON.parse(localStorage.getItem(LS_ENTRIES) || '{}');
    all[todayKey()] = entries;
    // BehÃ¥ll bara 30 dagars data
    const keys = Object.keys(all).sort();
    if (keys.length > 30) delete all[keys[0]];
    localStorage.setItem(LS_ENTRIES, JSON.stringify(all));
  } catch(e) { console.error('localStorage write failed:', e); }
}

function loadWeekEntries() {
  try {
    const all = JSON.parse(localStorage.getItem(LS_ENTRIES) || '{}');
    const days = [];
    for (let i = 6; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0,10);
      const entries = all[key] || [];
      const kcal = entries.reduce((s,e) => s + (+e.kalorier||0), 0);
      days.push(Math.round(kcal));
    }
    return days;
  } catch(e) { return [0,0,0,0,0,0,0]; }
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cfg = { url:'', kcal:2000, prot:150, karb:200, fat:65 };
let todayEntries = [];
let recognition = null;
let listening = false;
let charts = {};
let weekChart = null;

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  try {
    const saved = localStorage.getItem(LS_CFG);
    if (saved) cfg = {...cfg, ...JSON.parse(saved)};
  } catch(e) {}
  loadSettingsUI();
  todayEntries = loadEntries();
  buildDonutCharts();
  updateDashboard();
  renderLog();
}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  btn.classList.add('active');
  if (id === 'week') buildWeekChart();
  if (id === 'log') renderLog();
}

// â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadSettingsUI() {
  document.getElementById('s-url').value  = cfg.url;
  document.getElementById('s-kcal').value = cfg.kcal;
  document.getElementById('s-prot').value = cfg.prot;
  document.getElementById('s-karb').value = cfg.karb;
  document.getElementById('s-fat').value  = cfg.fat;
}

function saveSettings() {
  cfg.url  = document.getElementById('s-url').value.trim();
  cfg.kcal = +document.getElementById('s-kcal').value;
  cfg.prot = +document.getElementById('s-prot').value;
  cfg.karb = +document.getElementById('s-karb').value;
  cfg.fat  = +document.getElementById('s-fat').value;
  localStorage.setItem(LS_CFG, JSON.stringify(cfg));
  updateDashboard();
  alert('Sparat!');
}

// â”€â”€ VOICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleListen() {
  if (listening) { stopListen(); return; }
  startListen();
}

function startListen() {
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    setStatus('RÃ¶stinmatning krÃ¤ver Chrome', 'red'); return;
  }
  if (!cfg.url) {
    setStatus('Fyll i Apps Script URL under MÃ¥l fÃ¶rst', 'red'); return;
  }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = 'sv-SE';
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.onstart = () => {
    listening = true;
    document.getElementById('ptb').classList.add('listening');
    document.getElementById('transcript').textContent = 'Lyssnar...';
    document.getElementById('result-box').style.display = 'none';
    setStatus('');
  };
  recognition.onresult = e => {
    let interim = '', final = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    document.getElementById('transcript').textContent = final || interim || 'Lyssnar...';
    if (final) processText(final);
  };
  recognition.onerror = e => { setStatus('Fel: '+e.error, 'red'); stopListen(); };
  recognition.onend = () => stopListen();
  recognition.start();
}

function stopListen() {
  listening = false;
  if (recognition) recognition.stop();
  document.getElementById('ptb').classList.remove('listening');
}

// â”€â”€ PROCESS: rÃ¶st â†’ Apps Script â†’ spara â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchWithRetry(url, attempts=3) {
  for (let i = 0; i < attempts; i++) {
    try {
      const res = await fetch(url, { redirect: 'follow' });
      return await res.text();
    } catch(e) {
      if (i === attempts - 1) throw e;
      await new Promise(r => setTimeout(r, 1000 * (i + 1))); // vÃ¤nta 1s, 2s
    }
  }
}

async function processText(text) {
  setStatus('Analyserar livsmedel...');
  try {
    const raw = await fetchWithRetry(
      `${cfg.url}?action=parse_food&text=${encodeURIComponent(text)}`
    );
    const clean = raw.replace(/```json|```/g,'').trim();
    const entries = JSON.parse(clean);

    if (!entries || !entries.length) {
      setStatus('Kunde inte tolka det du sa', 'red'); return;
    }

    // 1. Visa resultat direkt
    showResultBox(entries);

    // 2. Spara lokalt (primÃ¤r lagring â€” fungerar alltid)
    const now = new Date();
    const tid = now.toTimeString().slice(0,5);
    const enriched = entries.map(e => ({...e, tid}));
    todayEntries.push(...enriched);
    saveEntries(todayEntries);
    updateDashboard();
    renderLog();
    setStatus('âœ“ Loggat!', 'green');

    // 3. Synka till Sheets (sekundÃ¤r â€” tyst om det misslyckas)
    for (const e of enriched) {
      fetch(`${cfg.url}?action=add_entry&livsmedel=${enc(e.livsmedel)}&antal=${e.antal}&enhet=${enc(e.enhet)}&kalorier=${e.kalorier}&protein=${e.protein}&kolhydrater=${e.kolhydrater}&fett=${e.fett}`)
        .catch(() => {});
    }
  } catch(err) {
    if (err.message.includes('fetch')) {
      setStatus('NÃ¤tverksfel â€“ fÃ¶rsÃ¶ker igen om du trycker pÃ¥ knappen', 'red');
    } else {
      setStatus('Fel: '+err.message, 'red');
    }
  }
}

function showResultBox(entries) {
  const box = document.getElementById('result-box');
  box.style.display = 'block';
  box.innerHTML = entries.map(e => `
    <div class="entry">
      <div>
        <div>${e.antal} ${e.enhet} ${e.livsmedel}</div>
        <div style="font-size:11px;color:var(--muted)">P:${e.protein}g K:${e.kolhydrater}g F:${e.fett}g</div>
      </div>
      <div class="entry-kcal">${e.kalorier} kcal</div>
    </div>`).join('');
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getTotals() {
  return todayEntries.reduce((a,e) => ({
    kcal: a.kcal + (+e.kalorier||0),
    prot: a.prot + (+e.protein||0),
    karb: a.karb + (+e.kolhydrater||0),
    fat:  a.fat  + (+e.fett||0)
  }), {kcal:0, prot:0, karb:0, fat:0});
}

function updateDashboard() {
  const t = getTotals();
  document.getElementById('cal-val').textContent  = `${Math.round(t.kcal)} / ${cfg.kcal} kcal`;
  document.getElementById('prot-val').textContent = `${t.prot.toFixed(1)}g / ${cfg.prot}g`;
  document.getElementById('karb-val').textContent = `${t.karb.toFixed(1)}g / ${cfg.karb}g`;
  document.getElementById('fat-val').textContent  = `${t.fat.toFixed(1)}g / ${cfg.fat}g`;
  if (charts.calChart) {
    updateDonut('calChart',  t.kcal, cfg.kcal, '#e94560');
    updateDonut('protChart', t.prot, cfg.prot, '#4cc9f0');
    updateDonut('karbChart', t.karb, cfg.karb, '#f8961e');
    updateDonut('fatChart',  t.fat,  cfg.fat,  '#a8dadc');
  }
}

// â”€â”€ DONUT CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildDonutCharts() {
  [['calChart','#e94560'],['protChart','#4cc9f0'],['karbChart','#f8961e'],['fatChart','#a8dadc']].forEach(([id,color]) => {
    const ctx = document.getElementById(id).getContext('2d');
    charts[id] = new Chart(ctx, {
      type:'doughnut',
      data:{ datasets:[{ data:[0,100], backgroundColor:[color,'#2a2a3e'], borderWidth:0 }] },
      options:{ cutout:'75%', plugins:{legend:{display:false},tooltip:{enabled:false}}, animation:{duration:600} }
    });
  });
}

function updateDonut(id, val, max, color) {
  const pct = Math.min((val/max)*100, 100);
  charts[id].data.datasets[0].data = [pct, 100-pct];
  charts[id].data.datasets[0].backgroundColor = [color, pct>=100?color+'44':'#2a2a3e'];
  charts[id].update();
}

let logDayOffset = 0; // 0 = idag, -1 = igÃ¥r osv

function changeLogDay(dir) {
  const newOffset = logDayOffset + dir;
  if (newOffset > 0) return; // kan inte gÃ¥ framÃ¥t fÃ¶rbi idag
  logDayOffset = newOffset;
  renderLog();
}

function getLogDate() {
  const d = new Date();
  d.setDate(d.getDate() + logDayOffset);
  return d;
}

function getLogKey() {
  return getLogDate().toISOString().slice(0,10);
}

function getEntriesForDay(key) {
  try {
    const all = JSON.parse(localStorage.getItem(LS_ENTRIES) || '{}');
    return all[key] || [];
  } catch(e) { return []; }
}

// â”€â”€ LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLog() {
  const date = getLogDate();
  const key = getLogKey();
  const entries = logDayOffset === 0 ? todayEntries : getEntriesForDay(key);

  // Datumrubrik
  const days = ['SÃ¶ndag','MÃ¥ndag','Tisdag','Onsdag','Torsdag','Fredag','LÃ¶rdag'];
  const isToday = logDayOffset === 0;
  const isYesterday = logDayOffset === -1;
  document.getElementById('log-date-label').textContent =
    isToday ? 'Idag' : isYesterday ? 'IgÃ¥r' : days[date.getDay()];
  document.getElementById('log-date-sub').textContent =
    date.toLocaleDateString('sv-SE', {day:'numeric', month:'long'});

  // DÃ¶lj framÃ¥t-pil om vi Ã¤r pÃ¥ idag
  document.getElementById('log-next-btn').style.opacity = logDayOffset === 0 ? '0.3' : '1';

  // Dagsummering
  const totals = entries.reduce((a,e) => ({
    kcal: a.kcal+(+e.kalorier||0),
    prot: a.prot+(+e.protein||0),
    karb: a.karb+(+e.kolhydrater||0),
    fat:  a.fat+(+e.fett||0)
  }), {kcal:0,prot:0,karb:0,fat:0});

  document.getElementById('log-day-totals').innerHTML = entries.length ? `
    <span style="background:var(--card2);border-radius:8px;padding:4px 10px;font-size:12px;color:var(--accent)">${Math.round(totals.kcal)} kcal</span>
    <span style="background:var(--card2);border-radius:8px;padding:4px 10px;font-size:12px;color:#4cc9f0">P: ${totals.prot.toFixed(1)}g</span>
    <span style="background:var(--card2);border-radius:8px;padding:4px 10px;font-size:12px;color:#f8961e">K: ${totals.karb.toFixed(1)}g</span>
    <span style="background:var(--card2);border-radius:8px;padding:4px 10px;font-size:12px;color:#a8dadc">F: ${totals.fat.toFixed(1)}g</span>
  ` : '';

  // Lista
  const el = document.getElementById('log-list');
  if (!entries.length) { el.innerHTML = '<div class="empty">Inget loggat denna dag</div>'; return; }
  el.innerHTML = [...entries].reverse().map(e => `
    <div class="log-item">
      <div>
        <div class="log-name">${e.antal} ${e.enhet} ${e.livsmedel}</div>
        <div class="log-detail">P:${(+e.protein).toFixed(1)}g Â· K:${(+e.kolhydrater).toFixed(1)}g Â· F:${(+e.fett).toFixed(1)}g</div>
        <div class="log-time">${e.tid||''}</div>
      </div>
      <div class="log-kcal">${e.kalorier} kcal</div>
    </div>`).join('');
}

// â”€â”€ WEEK CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildWeekChart() {
  const dayLabels = ['MÃ¥n','Tis','Ons','Tor','Fre','LÃ¶r','SÃ¶n'];
  const today = new Date().getDay();
  const ordered = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate()-i);
    ordered.push(dayLabels[d.getDay() === 0 ? 6 : d.getDay()-1]);
  }
  const data = loadWeekEntries();
  const ctx = document.getElementById('weekChart').getContext('2d');
  if (weekChart) weekChart.destroy();
  weekChart = new Chart(ctx, {
    type:'bar',
    data:{
      labels: ordered,
      datasets:[
        { label:'Kalorier', data, backgroundColor:'rgba(233,69,96,0.7)', borderRadius:8, borderSkipped:false },
        { label:'MÃ¥l', data:Array(7).fill(cfg.kcal), type:'line', borderColor:'#4cc9f0', borderDash:[5,5], borderWidth:2, pointRadius:0, fill:false }
      ]
    },
    options:{
      responsive:true,
      plugins:{ legend:{labels:{color:'#888',font:{size:11}}} },
      scales:{
        x:{ ticks:{color:'#888'}, grid:{color:'#2a2a3e'} },
        y:{ ticks:{color:'#888'}, grid:{color:'#2a2a3e'}, beginAtZero:true }
      }
    }
  });

  const avg = data.reduce((a,b)=>a+b,0)/7;
  document.getElementById('week-stats').innerHTML = `
    <div style="background:var(--card2);border-radius:12px;padding:14px;text-align:center">
      <div style="font-size:11px;color:var(--muted)">SNITT/DAG</div>
      <div style="font-size:22px;font-weight:700;color:var(--accent)">${Math.round(avg)}</div>
      <div style="font-size:11px;color:var(--muted)">kcal</div>
    </div>
    <div style="background:var(--card2);border-radius:12px;padding:14px;text-align:center">
      <div style="font-size:11px;color:var(--muted)">VECKOTOTAL</div>
      <div style="font-size:22px;font-weight:700;color:var(--blue)">${data.reduce((a,b)=>a+b,0)}</div>
      <div style="font-size:11px;color:var(--muted)">kcal</div>
    </div>`;
}

// â”€â”€ RENSA IDAG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearToday() {
  if (!confirm('Rensa all data fÃ¶r idag?')) return;
  todayEntries = [];
  saveEntries([]);
  updateDashboard();
  renderLog();
  setStatus('âœ“ Dagens data rensad', 'green');
  if (cfg.url) fetch(`${cfg.url}?action=clear_today`).catch(()=>{});
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(msg, color) {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.style.color = color==='red' ? 'var(--accent)' : color==='green' ? 'var(--green)' : 'var(--muted)';
}
function enc(s) { return encodeURIComponent(s); }

init();
</script>
</body>
</html>
